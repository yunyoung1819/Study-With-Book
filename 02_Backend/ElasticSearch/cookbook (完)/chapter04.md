# :book: 엘라스틱서치 쿡북

###### 엘라스틱서치 쿡북을 읽고 그 내용을 요약한 글 입니다. 상세 내용은 책을 참조해주세요.

---------------------------------------------------------------------------

## :pushpin: 4장. 기본 작업

### 색인 생성

- 일래스틱서치에서 데이터를 색인하기 전 첫 작업은 데이터의 주 컨테이너라고 할 수 있는 색인을 만드는 것이다.
- 색인은 SQL에서 데이터베이스 개념
- 타입(SQL에서 테이블)과 도큐먼트(SQL에서 레코드)를 위한 컨테이너다.
- 색인 생성을 위한 HTTP 메소드는 PUT(POST 역시 동작한다)이고, REST URL은 색인 이름을 포함한다.

````
http://<서버>/<색인_이름>
````

- 색인을 작성할 때 복제는 settings/index 객체에서 다음 두 파라미터로 설정할 수 있다.
    - number_of_shards: 색인을 작성하는 샤드 개수를 제어한다.
    - number_of_replicas: 복제 개수를 제어한다. 이 값은 1 이상으로 설정하는 것이 좋다.
- 색인 생성 API는 생성 시간에 매핑을 정의할 수 있다.
- 매핑을 정의하는데 필요한 파라미터가 mappings이고, 다중 매핑을 허용한다.
- 색인 이름에는 몇 가지 제약 사항이 있는데, 허용 문자는 다음과 같다.
    - 아스키 문자 [a-z]
    - 숫자 [0-9]
    - 마침표., 마이너스 -, &, _


### 색인 삭제

- 색인 삭제는 색인의 샤드, 매핑, 데이터를 삭제한다.
- 색인 삭제를 위한 HTTP 메소드는 DELETE다.
````
http://<서버>/<색인_이름>
````

- 전체 색인 삭제 비활성화
````
action.destructive_requires_name: true
````


### 색인 열고 닫기
- 데이터를 유지하면서 자원(메모리/CPU)을 절약하려면 색인을 삭제하는 대신 닫아두는 것이 좋다.
- 일래스틱서치는 색인을 열거나 닫아 온라인이나 오프라인 모드로 설정할 수 있다.
- 색인 닫기 
````
curl -XPOST http://127.0.0.1:9200/myindex/_close
````
- 색인 열기
````
curl -XPOST http://127.0.0.1:9200/myindex/_open
````

### 색인에 매핑 입력

- 커맨드라인을 통해 curl을 실행하려면 운영체제에 curl을 설치해야 한다.
- 매핑을 입력하기 위한 HTTP 메소드는 PUT(물론 POST도 동작한다)이고, 매핑 입력의 URL 형식은 다음과 같다.
````
http://<서버>/<색인_이름>/<타입_이름>/_mapping
````
- 매핑이 삽입될 때 같은 타입의 매핑이 있다면 새 매핑과 병합한다.
- 다른 유형의 필드가 이미 있다면 업데이트할 수 없으므로 필드 속성을 확장하는 예외가 나타날 것이다.
- PUT 매핑 호출은 쉼표로 구분한 색인 목록이나 _all 앨리어스를 사용하는 전체 색인에 적용하는 것으로, 여러 색인 타입을 한 번에 설정할 수 있다.


### 매핑 삭제
- 매핑을 위한 삭제 작업은 없다. 즉 색인에서 단일 매핑을 삭제할 수 없다.
- 매핑을 삭제하거나 변경하려면 다음 절차를 실행해야 한다.

1. 신규 또는 변경한 매핑으로 새 색인을 만든다.
2. 전체 레코드를 다시 색인한다.
3. 잘못된 매핑을 가진 기존 색인을 삭제한다.


### 매핑 조회
- 매핑 정보를 조회하는 HTTP 메소드는 GET이고, 매핑 조회를 위한 URL 형식은 다음과 같다.
````
http://<서버>/_mapping
http://<서버>/<색인_이름>/_mapping
http://<서버>/<색인_이름>/<타입_이름>/_mapping
````

### 색인 재생성
- 색인을 다시 생성하는 HTTP 메소드는 POST이고, URL 형식은 다음과 같다.
````
http://<서버>/_reindex
````

### 색인 새로고침
````
http://<서버>/<색인_이름(또는 쉼표로 구분한 다중 색인)>/_refresh
````


### 색인 강제 병합
- 강제 병합(ForceMerge) 작업은 색인을 통합해 세그먼트 수를 줄이고 검색 성능을 더 빠르게 한다.


### 색인 설정 관리
- 색인 설정은 샤딩/레플리카, 캐시, 텀(term) 관리, 라우팅(routing), 분석 등과 같이 일부 일래스틱서치의 중요한 기능을 제어할 수 있어서 중요하다.
````
http://<서버>/<색인_이름>/_settings
````

### 색인 앨리어스 사용
- 실제 애플리케이션에는 수많은 색인과 더 많은 색인을 사용하는 쿼리가 있다. 
이런 시나리오에서는 쿼리의 모든 색인 이름을 정의해야할 것이다. 앨리어스를 사용하면 공통 이름으로 그룹 지을 수 있다.
    - 지난 주, 지난 달, 오늘, 어제 등의 앨리어스를 만들려는 날짜로 나눈 로그 색인(즉, log_YYMMDD). 
````
http://<서버>/_aliases
http://<서버>/<색인>/_alias/<색인이름>
````

### 색인 롤오버
- 로그를 관리하는 시스템을 사용할 때 일반적으로 로그 항목에 롤링 파일(rolling file)을 사용한다.
- 검사할 조건을 정의하고 이를 일래스틱서치에 남겨두면 자동으로 새 색인을 롤링하고 앨리어스를 통해
가상 색인만 참조하게 할 수 있다. 


### 도큐먼트 색인
- 일래스틱서치에 있어 두 가지 중요한 작업은 색인과 검색이다. 색인은 하나 이상의 도큐먼트를 색인에 저장하는 것을 의미한다.
이는 관계형 데이터베이스에서 레코드를 추가하는 개념과 유사하다.

- 도큐먼트 조회

````
http://<서버>/<색인_이름>/<타입_이름>/<id>
````
- 도큐먼트 삭제
    - REST API URL은 GET 호출과 같지만 HTTP 메소드만 DELETE 다.

- 도큐먼트 업데이트
````
http://<서버>/<색인_이름>/<타입_이름>/<id>/_update
````

### 원자성 작업 속도 향상 (벌크 작업)

- 다량의 도큐먼트를 입력/삭제/변경할 때 HTTP 오버헤드는 두드러진다. 속도 향상을 위해 일래스틱서치는
벌크 CRUD 호출을 실행할 수 있다.

````
http://<서버>/<색인_이름>/_bulk
````

### GET 작업 속도 향상 (다중 GET

````
http://<서버>/_mget
````