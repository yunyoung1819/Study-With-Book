# :book: Real MySQL

## :pushpin: Chapter 01. 소개
### MySQL 소개 
- MySQL은 소스가 공개된 오픈소스 데이터베이스

### 왜 MySQL인가?
- MySQL과 오라클을 비교해본다면 당연히 MySQL의 경쟁력은 가격이나 비용일 것이다.

---

## :pushpin: Chapter 02. 설치와 설정 
- MySQL 서버가 설치된 디렉터리는 `/usr/local/mysql` 이며 하위의 각 디렉토리의 정보는 다음과 같다.
  - bin: MySQL 서버와 클라이언트 프로그램, 유틸리티를 위한 디렉터리
  - data: 로그 파일과 데이터 파일들이 저장되는 디렉터리
  - include: C/C++ 헤더 파일들이 저장된 디렉터리
  - lib: 라이브러리 파일들이 저장된 디렉터리
  - share: 다양한 지원 파일들이 저장돼 있으며, 에러 메시지나 샘플 설정 파일(my.cnf)이 있는 디렉터리

### MySQL 8.0 업그레이드 시 고려 사항
- 사용자 인증 방식 변경
- MySQL 8.0과의 호환성 체크
- 외래키 이름의 길이
  - MySQL 8.0에서는 외래키(Foreign Key)의 이름이 64글자로 제한
- 인덱스 힌트
- GROUP BY에 사용된 정렬 옵션
- 파티션을 위한 공용 테이블스페이스

### 서버 설정
- 일반적으로 MySQL 서버는 단 하나의 설정 파일을 사용
- 리눅스를 포함한 유닉스 계열에서는 my.cnf
- 윈도우 계열에서는 my.ini

만약 설치된 MySQL 서버가 어느 디렉터리에서 my.cnf 파일을 읽는지 궁금하다면?
```shell
mysqld --verbose --help
```

### 시스템 변수
- MySQL 서버는 기동하면서 설정 파일의 내용을 읽어 메모리나 작동 방식을 초기화하고 접속된 사용자를 제어하기 위해 이러한 값을 별도로 저장해둠
- 이렇게 저장된 값을 시스템 변수(System Variables)라고 함

```shell
SHOW GLOBAL VARIABLES;
```

---
## :pushpin: Chapter 04. 아키텍처 

### MySQL 엔진 아키텍처
- MySQL 서버는 사람의 머리 역할을 담당하는 MySQL 엔진과 손발 역할을 담당하는 스토리지 엔진으로 구분
- 이 둘을 모두 합쳐서 그냥 MySQL 또는 MySQL 서버라고 표현함

### MySQL 엔진
- MySQL 엔진은 클라이언트로부터의 접속 및 쿼리 요청을 처리하는 커넥션 핸들러와 SQL 파서 및 전처리기, 쿼리의 최적화된 실행을 위한 옵티마이저가 중심
- MySQL은 표준 SQL(ANSI SQL) 문법을 지원하기 때문에 표준 문법에 따라 작성된 쿼리는 타 DBMS와 호환되어 실행될 수 있음

### 스토리지 엔진
- MySQL 엔진: 요청된 SQL 문장을 분석하거나 최적화하는등 DBMS의 두뇌에 해당하는 처리를 수행
- 스토리지 엔진: 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분을 전담

### 핸들러 API
- 쿼리 실행기에서 데이터를 쓰거나 읽어야할 때는 각 스토리지 엔진에 쓰기 또는 읽기를 요청. 이러한 요청을 핸들러(Handler) 요청이라고 함
- 여기서 사용되는 API를 핸들러 API라고 함

### MySQL 스레딩 구조
- MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동
  - 포그라운(Foreground) 스레드
  - 백그라운드(Backgroud) 스레드
- 실행 중인 스레드의 목록은 performance_schema 데이터베이스의 threads 테이블에서 확인
- 동일한 이름의 스레드가 2개 이상씩 보이는 것은 여러 스레드가 동일 작업을 병렬로 처리하는 경우

```sql
select thread_id, name, type, processlist_user, processlist_host from performance_schema.threads order by type, thread_id;
```

### 포그라운드 스레드(클라이언트 스레드)
- 최소한 MySQL 서버에 접속된 클라이언트의 수만큼 존재하며 주로 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리
- thread_cache_size

### 백그라운드 스레드 
- InnoDB는 다음과 같은 여러가지 작업이 백그라운드로 처리됨
  - 인서트 버퍼를 병합하는 스레드
  - 로그를 디스크로 기록하는 스레드
  - InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
  - 데이터를 버퍼로 읽어오는 스레드
  - 잠금이나 데드락을 모니터링하는 스레드

### 메모리 할당 및 사용 구조
- MySQL에서 사용되는 메모리 공간은 크게 `글로벌 메모리 영역`과 `로컬 메모리 영역`으로 구분할 수 있음
- 글로벌 메모리 영역의 모든 메모리 공간은 MySQL 서버가 시작되면서 운영체제로부터 할당됨
- 글로벌 메모리 영역과 로컬 메모리 영역은 MySQL 서버 내에 존재하는 많은 스레드가 공유해서 사용하는 공간인지 여부에 따라 구분

### 글로벌 메모리 영역
- 클라이언트 스레드 수와 무관하게 하나의 메모리 공간만 할당됨
- 대표적인 글로벌 메모리 영역
  - 테이블 캐시
  - InnoDB 버퍼 풀
  - InnoDB 어댑티브 해시 인덱스
  - InnoDB 리두 로그 버퍼

### 로컬 메모리 영역
- MySQL 서버상에 존재하는 클라이언트 스레드가 쿼리를 처리하는데 사용되는 메모리 영역
- 로컬 메모리는 각 클라이언트 스레드별로 독립적으로 할당되며 절대 공유되어 사용되지 않는다는 특징이 있음
- 대표적인 로컬 메모리 영역
  - 정렬 버퍼(Sort buffer)
  - 조인 버퍼
  - 바이너리 로그 캐시
  - 네트워크 버퍼

### 플러그인 스토리지 엔진 모델
- MySQL의 독특한 구조 중 대표적인 것이 바로 플러그인 모델
- MySQL에서 쿼리가 실행되는 과정
  - 거의 대부분의 작업이 MySQL 엔진에서 처리
  - 데이터 읽기/쓰기 작업만 스토리지 엔진에 의해 처리
- 사람이 핸들(운전대)을 이용해 자동차를 운전하듯이 프로그래밍 언어에서는 어떤 기능을 호출하기 위해 사용하는 운전대와 같은 역할을 하는 객체를 핸들러라고 표현
- MySQL 엔진이 스토리지 엔진을 조정하기 위해 핸들러를 사용
- MySQL 서버에서는 스토리지 엔진뿐만 아니라 다양한 기능을 플러그인 형태로 지원한다.
  - 인증이나 전문 검색 파서 또는 쿼리 재작성과 같은 플러그인이 있음
  - 비밀번호 검증과 커넥션 제어 등에 관련된 다양한 플러그인이 제공

### 컴포넌트
- MySQL 8.0부터는 기존의 플러그인 아키텍처를 대체하기 위해 컴포넌트 아키텍처가 지원됨


### 쿼리 실행 구조

```mermaid
flowchart LR
    A[SQL 요청]
    B[쿼리 파서]
    C[전처리기]
    D[옵티마이저]
    E[쿼리실행기]
    F[스토리지 엔진]
    A --> B --> C --> D --> E --> F
```

#### 쿼리 파서
- 사용자 요청으로 들어온 쿼리 문장을 `토큰`(MySQL이 인식할 수 있는 최소 단위의 어휘나 기호)으로 분리해 트리 형태의 구조로 만들어냄

#### 전처리기
- 파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인한다.

### 옵티마이저
- 옵티마이저는 사용자의 요청으로 들어온 쿼리 문장을 저렴한 비용으로 가장 빠르게 처리할지를 결정하는 역할을 담당
- DBMS의 두뇌에 해당 

#### 실행엔진
- 옵티마이저가 두뇌라면 실행 엔진과 핸들러는 손과 발에 비유할 수 있음

#### 핸들러
- 핸들러는 스토리지 엔진을 의미
- MySQL 실행 엔진의 요청에 따라 데이터를 디스크로 저장하고 디스크로부터 읽어오는 역할을 담당
- MyISAM 스토리지 엔진, InnoDB 스토리지 엔진

### 쿼리 캐시
- MySQL 8.0으로 올라오면서 쿼리 캐시는 MySQL 서버의 기능에서 완전히 제거되고 관련된 시스템 변수도 모두 제거됨

### 스레드 풀
- 스레드 풀: 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여서 동시 처리되는 요청이 많다하더라도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 해서 서버의 자원 소모를 줄이는 것이 목적 

### 트랜잭션 지원 메타데이터
- 데이터 딕셔너리 또는 메타데이터: 데이터베이스 서버에서 테이블의 구조 정보와 스토어드 프로그램 등의 정보
- 시스템 테이블: MySQL 서버가 작동하는데 기본적으로 필요한 테이블들을 묶어서 시스템 테이블이라고 한다.


## :seedling: InnoDB 스토리지 엔진 아키텍처
- InnoDB는 MySQL에서 사용할 수 있는 스토리지 엔진 중 거의 유일하게 레코드 기반의 잠금을 제공
- 그때문에 높은 동시성 처리가 가능하고 안정적이며 성능이 뛰어남

### 프라이머리 키에 의한 클러스터링
- **InnoDB의 모든 테이블은 프라이머리 키를 기준으로 클러스터링되어 저장된다.**
- 즉, 프라이머리 키 값의 순서대로 디스크에 저장되며 모든 세컨더리 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용
- 프라이[..](../..)머리 키가 클러스터링 인덱스이기 떄문에 프라이머리 키를 이용한 레인지 스캔은 상당히 빨리 처리될 수 있음
- InnoDB 스토리지 엔진과는 달리 MyISAM 스토리지 엔진에서는 클러스터링 키를 지원하지 않는다.

### 외래 키 지원 
- foreign_key_checks 시스템 변수를 off로 설정하면 외래 키 관계에 대한 체크 작업을 일시적으로 멈출 수 있다.

```mysql
SET foreign_key_checks = OFF;

SET foreign_key_checks = ON;
```

### MVCC
- 멀티 버전이라 함은 하나의 레코드에 대해 여러 개의 버전이 동시에 관리된다는 의미
- InnoDB는 언두 로그(Undo log)를 이용해 이 기능을 구현함
- UPDATE 쿼리가 실행되면 InnoDB 버퍼 풀은 즉시 새로운 데이터로 변경되고 기존 데이터는 언두 영역으로 복사
  - 이 상태에서 COMMIT 명령을 실행하면 InnoDB는 더 이상의 변경 작업 없이 지금의 상태를 영구적인 데이터로 만듬
  - 롤백을 실행하면 InnoDB는 언두 영역에 있는 백업된 데이터를 InnoDB 버퍼 풀로 다시 복구하고 언두 영역의 내용을 삭제한다.

